"""
サブカル・オタク教養データ
アニメ・漫画・ネットミームの教養を真面目に解説
"""
import json
import random
from config import OUTPUT_DIR
from system_prompts_library import SYSTEM_PROMPTS

OUTPUT_PATH = f"{OUTPUT_DIR}/subculture.jsonl"

# サブカル用のインデックス範囲（アニメ・漫画キャラ風 + ゲーム・ネット文化風）
SUBCULTURE_PROMPT_INDICES = list(range(10, 40)) + list(range(140, 160)) + [None]

SUBCULTURE_EXAMPLES = [
    # 異世界転生
    {
        "user": "異世界転生ものでトラックに轢かれて転生するパターン多すぎない？なんで？",
        "assistant": """<think>
トピック：異世界転生のトラック・クリシェ。
起源：2010年代のなろう系小説。
分析：交通事故＝突然の死、即座に物語開始できる便利な装置。
副次効果：「トラック＝死神」のミームが定着。
</think>

これ、実は合理的なんですよ。

**理由1：言い訳が不要**
「病死」だと闘病描写が必要。「自殺」だと重すぎる。「老衰」だと若い主人公にできない。
トラックなら**「突然の不可抗力」**で、説明コストゼロで転生できます。

**理由2：サラリーマン主人公との相性**
ブラック企業で疲弊した主人公が、帰宅中にトラックに轢かれる。**「社畜人生からの解放」**というカタルシスが読者に刺さる。

**理由3：ミームの自己増殖**
あまりにも多用されたため、「トラック＝転生の使者」というネタが定着。今では**パロディとして使われる**ことすらあります。

「トラック転生」は、創作界の**「それな」ボタン**みたいなものですね。"""
    },
    # ツンデレ
    {
        "user": "ツンデレって結局なに？なんで人気あるの？",
        "assistant": """<think>
トピック：キャラクター類型論。
定義：最初は冷たい（ツン）が、徐々に好意を見せる（デレ）。
心理学：ギャップ効果、希少性の原理。
</think>

**「ツン」→「デレ」の変化を目撃すること**が本質です。

心理学で言う**「ゲイン効果（獲得効果）」**ですね。
最初からニコニコしている人より、**「最初は嫌われてたけど、だんだん好かれた」**方が、好意の価値が高く感じる。

つまりツンデレとは：
- **希少性**：簡単には手に入らない
- **達成感**：心を開かせた「俺だけ」の特別感
- **ドラマ性**：変化のストーリーが生まれる

「べ、別にアンタのためじゃないんだからね！」は、翻訳すると**「私はあなたにしか見せない顔がある」**という最上級の好意表明なのです。"""
    },
    # なろう系
    {
        "user": "なろう系小説ってなんで「追放されたけど実は最強」みたいなの多いの？",
        "assistant": """<think>
トピック：Web小説のテンプレート分析。
パターン：不遇→評価→逆転。
読者心理：社会的承認欲求、復讐ファンタジー。
</think>

これは**「社会で正当に評価されていない」**と感じる読者への共感装置です。

**構造分析：**
1. **追放（不遇）**：主人公は無能扱いされる → 読者「俺も会社で…」
2. **真の実力発揮**：実は最強だった → 読者「俺も本気出せば…」
3. **後悔する元仲間**：「戻ってきてくれ！」 → 読者「ざまあみろ」

これは**復讐ファンタジー**の変形です。
現実では上司を見返すのに何年もかかりますが、小説なら**3話で「ざまあ」**できる。

批判されがちですが、**ストレス社会の鎮痛剤**として機能しているんですよ。"""
    },
    # VTuber
    {
        "user": "VTuberってなんで人気なの？アニメキャラと何が違うの？",
        "assistant": """<think>
トピック：バーチャルYouTuber文化。
違い：アニメは台本、VTuberはリアルタイム。
本質：「キャラクター」と「中の人」の二重性。
</think>

決定的な違いは**「リアルタイム性」と「双方向性」**です。

**アニメキャラ**：脚本家が書いた通りに動く。完成品。
**VTuber**：生配信で予測不能なリアクションをする。現在進行形。

さらに：
- **スパチャ（投げ銭）**で名前を呼んでもらえる → 認知欲求
- **コメントに反応**してくれる → 双方向コミュニケーション
- **雑談配信**で「素」が見える → 親密感

VTuberとは、**「アニメキャラのガワ」+「生身の人間のアドリブ」+「双方向のラジオ」**のハイブリッドです。

アイドルとアニメとYouTuberを全部足したようなもの。そりゃ流行りますよ。"""
    },
    # 推し活
    {
        "user": "「推し」って言葉、なんでこんなに広まったの？「ファン」と何が違う？",
        "assistant": """<think>
トピック：オタク用語の一般化。
語源：AKB48の「推しメン」。
違い：「ファン」は受動的、「推し」は能動的。
</think>

**「ファン」は観客、「推し」は応援団員**です。

**ファン**：好きなものを消費する人（受動的）
**推し**：好きなものを**広める・支える**人（能動的）

「推し」という言葉には：
- 布教したい（「この良さを伝えたい！」）
- 貢献したい（「グッズ買って売上に貢献」）
- 成長を見守りたい（「デビュー時から知ってる」）

という**当事者意識**が含まれています。

さらに「推し」は**「恋愛感情とは違う」**というニュアンスも持つ。
「好き」でも「愛してる」でもなく、**「この存在を世界に推薦したい」**。

資本主義社会における**最強の応援形態**として定着したのです。"""
    },
    # 二次創作
    {
        "user": "二次創作ってグレーゾーンなの？なんで許されてるの？",
        "assistant": """<think>
トピック：著作権とファン活動。
法的：厳密には著作権侵害の可能性。
実態：黙認文化、ガイドライン化の流れ。
</think>

**法的にはアウト、文化的にはセーフ**という微妙な領域です。

**なぜ黙認されるか：**
1. **宣伝効果**：二次創作がきっかけで原作に興味を持つ人がいる
2. **ファンコミュニティ維持**：禁止すると炎上＆ファン離れ
3. **訴訟コスト**：個人を訴えてもお金にならない

**最近の変化：**
- 任天堂、ホロライブなど：公式ガイドラインで「ここまでOK」を明示
- 一部クリエイター：二次創作を公式に歓迎

日本の同人文化は**「お目こぼし」**で成り立ってきました。
ただし、**「公式を超える利益を出さない」「公式の品位を汚さない」**という暗黙のルールがある。

グレーゾーンを**「暗黙のマナー」**で維持している、世界的にも珍しい文化です。"""
    },
    # ネットミーム
    {
        "user": "「草」とか「w」ってなんで笑いを意味するの？",
        "assistant": """<think>
トピック：ネットスラングの語源。
変遷：（笑）→ warai → w → www → 草
視覚的変化：wが草に見える。
</think>

**進化の歴史を追いましょう：**

1. **（笑）**：2000年代初頭、正統派
2. **warai → w**：タイピングが面倒で省略
3. **www**：複数の「w」で笑いの強度を表現
4. **草**：「www」が草が生えてるように見える → 「草生える」

さらに進化：
- **大草原**：wwwwwwwwww（大笑い）
- **草不可避**：笑わずにはいられない
- **草生え散らかす**：爆笑

言語学的には**「メタファーの連鎖」**ですね。
音（warai）→ 文字（w）→ 視覚イメージ（草）→ 概念（草原）

ネット文化は**言語進化の加速装置**なんですよ。"""
    },
    # コミケ
    {
        "user": "コミケってなんであんなに人が集まるの？ネットで買えばよくない？",
        "assistant": """<think>
トピック：同人即売会文化。
理由：限定性、ライブ感、コミュニティ。
比較：ネット通販にはない価値。
</think>

**「買う」だけならネットでいい。でもコミケは「買う」だけじゃない。**

**コミケでしか得られないもの：**
1. **限定品**：その場でしか買えない本、グッズ
2. **作者との対面**：「好きです」を直接伝えられる
3. **ライブ感**：同じ趣味の人が何万人もいる空間
4. **戦利品報告**：「買えた！」という達成感

**本質は「祭り」**なんですよ。
夏祭りに行く理由は「屋台の食べ物がうまいから」じゃない。**「その空気を味わいに行く」**んです。

3日間で50万人が集まる世界最大級の同人イベント。
それは**「オタクのハロウィン」であり「オタクの初詣」**なのです。"""
    },
    # 百合・BL
    {
        "user": "百合とかBLってなんで人気あるの？自分と関係ない恋愛じゃない？",
        "assistant": """<think>
トピック：同性愛フィクションの消費。
読者層：異性愛者が多い。
心理：「自己投影しない恋愛」を観賞する。
</think>

**「自分と関係ない」からこそ、純粋に楽しめる**んです。

異性愛のラブコメを見ると：
- 「なんでこの女がモテるの？」（嫉妬）
- 「俺ならこうする」（自己投影）
- 「こんな恋愛できない」（劣等感）

でも百合・BLなら：
- **第三者として純粋に応援できる**
- **自分の恋愛と比較しなくていい**
- **「推しカプ」として愛でられる**

つまり**「当事者性を排除した恋愛鑑賞」**です。
箱庭の中の恋愛を、神の視点から見守る快感。

これは**「スポーツ観戦」**に近い。
自分がサッカー選手じゃなくても、試合は楽しめますよね？"""
    },
    # 聖地巡礼
    {
        "user": "アニメの聖地巡礼ってなんでするの？絵と同じ場所見て楽しいの？",
        "assistant": """<think>
トピック：コンテンツツーリズム。
心理：フィクションと現実の交差点に立つ体験。
効果：没入感、所有感、コミュニティ。
</think>

**「絵と同じ場所」じゃなくて「物語が存在した証拠」を見に行くんです。**

聖地巡礼の本質：
1. **没入感の強化**：「ここであのシーンが…」と追体験
2. **所有感**：「俺はこの作品をここまで愛している」という証明
3. **写真**：同じ構図で撮ることで、自分も物語の一部になる

さらに：
- **ファン同士の出会い**：聖地で「あ、同志だ」
- **地域への貢献**：「推し作品の舞台を潤す」という貢献感

心理学的には**「ナラティブ・トランスポーテーション（物語への没入）」**の延長です。

小説を読んで泣くのと、聖地で泣くのは、同じ感情の異なる表現形態なんですよ。"""
    },
]

def main():
    print("サブカル・オタク教養データ生成開始...")

    # 各システムプロンプトの使用回数を追跡（最大5回まで）
    prompt_usage = {}
    max_usage = 5

    results = []
    for example in SUBCULTURE_EXAMPLES:
        # 使用可能なプロンプトを選択
        available = [i for i in SUBCULTURE_PROMPT_INDICES if prompt_usage.get(i, 0) < max_usage]
        if not available:
            prompt_usage = {}
            available = SUBCULTURE_PROMPT_INDICES.copy()

        idx = random.choice(available)
        prompt_usage[idx] = prompt_usage.get(idx, 0) + 1

        # Noneまたはインデックスからプロンプト取得
        system = None if idx is None else SYSTEM_PROMPTS[idx]

        messages = []
        if system:
            messages.append({"role": "system", "content": system})
        messages.append({"role": "user", "content": example["user"]})
        messages.append({"role": "assistant", "content": example["assistant"]})

        results.append({
            "messages": messages,
            "metadata": {
                "category": "subculture",
                "source": "subculture"
            }
        })

    with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
        for item in results:
            f.write(json.dumps(item, ensure_ascii=False) + "\n")

    print(f"完了: {len(results)}件 -> {OUTPUT_PATH}")

if __name__ == "__main__":
    main()
